/* global _wpRevisionsSettings, isRtl */window.wp=window.wp||{};(function(e){var t;t=wp.revisions={model:{},view:{},controller:{}};t.settings=_.isUndefined(_wpRevisionsSettings)?{}:_wpRevisionsSettings;t.debug=!1;t.log=function(){window.console&&t.debug&&window.console.log.apply(window.console,arguments)};e.fn.allOffsets=function(){var t=this.offset()||{top:0,left:0},n=e(window);return _.extend(t,{right:n.width()-t.left-this.outerWidth(),bottom:n.height()-t.top-this.outerHeight()})};e.fn.allPositions=function(){var e=this.position()||{top:0,left:0},t=this.parent();return _.extend(e,{right:t.outerWidth()-e.left-this.outerWidth(),bottom:t.outerHeight()-e.top-this.outerHeight()})};t.settings.to&&(t.settings.to=parseInt(t.settings.to,10));t.settings.from&&(t.settings.from=parseInt(t.settings.from,10));t.settings.compareTwoMode&&(t.settings.compareTwoMode=t.settings.compareTwoMode==="1");t.model.Slider=Backbone.Model.extend({defaults:{value:null,values:null,min:0,max:1,step:1,range:!1,compareTwoMode:!1},initialize:function(e){this.frame=e.frame;this.revisions=e.revisions;this.listenTo(this.frame,"update:revisions",this.receiveRevisions);this.listenTo(this.frame,"change:compareTwoMode",this.updateMode);this.listenTo(this,"change:from",this.handleLocalChanges);this.listenTo(this,"change:to",this.handleLocalChanges);this.listenTo(this,"change:compareTwoMode",this.updateSliderSettings);this.listenTo(this,"update:revisions",this.updateSliderSettings);this.listenTo(this,"change:hoveredRevision",this.hoverRevision);this.set({max:this.revisions.length-1,compareTwoMode:this.frame.get("compareTwoMode"),from:this.frame.get("from"),to:this.frame.get("to")});this.updateSliderSettings()},getSliderValue:function(e,t){return isRtl?this.revisions.length-this.revisions.indexOf(this.get(e))-1:this.revisions.indexOf(this.get(t))},updateSliderSettings:function(){this.get("compareTwoMode")?this.set({values:[this.getSliderValue("to","from"),this.getSliderValue("from","to")],value:null,range:!0}):this.set({value:this.getSliderValue("to","to"),values:null,range:!1});this.trigger("update:slider")},hoverRevision:function(e,t){this.trigger("hovered:revision",t)},updateMode:function(e,t){this.set({compareTwoMode:t})},handleLocalChanges:function(){this.frame.set({from:this.get("from"),to:this.get("to")})},receiveRevisions:function(e,t){if(this.get("from")===e&&this.get("to")===t)return;this.set({from:e,to:t},{silent:!0});this.trigger("update:revisions",e,t)}});t.model.Tooltip=Backbone.Model.extend({defaults:{revision:null,offset:{},hovering:!1,scrubbing:!1},initialize:function(e){this.frame=e.frame;this.revisions=e.revisions;this.slider=e.slider;this.listenTo(this.slider,"hovered:revision",this.updateRevision);this.listenTo(this.slider,"change:hovering",this.setHovering);this.listenTo(this.slider,"change:scrubbing",this.setScrubbing)},updateRevision:function(e){this.set({revision:e})},setHovering:function(e,t){this.set({hovering:t})},setScrubbing:function(e,t){this.set({scrubbing:t})}});t.model.Revision=Backbone.Model.extend({});t.model.Revisions=Backbone.Collection.extend({model:t.model.Revision,initialize:function(){_.bindAll(this,"next","prev")},next:function(e){var t=this.indexOf(e);if(t!==-1&&t!==this.length-1)return this.at(t+1)},prev:function(e){var t=this.indexOf(e);if(t!==-1&&t!==0)return this.at(t-1)}});t.model.Field=Backbone.Model.extend({});t.model.Fields=Backbone.Collection.extend({model:t.model.Field});t.model.Diff=Backbone.Model.extend({initialize:function(){var e=this.get("fields");this.unset("fields");this.fields=new t.model.Fields(e)}});t.model.Diffs=Backbone.Collection.extend({initialize:function(e,t){_.bindAll(this,"getClosestUnloaded");this.loadAll=_.once(this._loadAll);this.revisions=t.revisions;this.requests={}},model:t.model.Diff,ensure:function(t,n){var r=this.get(t),i=this.requests[t],s=e.Deferred(),o={},u=t.split(":")[0],a=t.split(":")[1];o[t]=!0;wp.revisions.log("ensure",t);this.trigger("ensure",o,u,a,s.promise());if(r)s.resolveWith(n,[r]);else{this.trigger("ensure:load",o,u,a,s.promise());_.each(o,_.bind(function(e){this.requests[e]&&delete o[e];this.get(e)&&delete o[e]},this));if(!i){o[t]=!0;i=this.load(_.keys(o))}i.done(_.bind(function(){s.resolveWith(n,[this.get(t)])},this)).fail(_.bind(function(){s.reject()}))}return s.promise()},getClosestUnloaded:function(e,t){var n=this;return _.chain([0].concat(e)).initial().zip(e).sortBy(function(e){return Math.abs(t-e[1])}).map(function(e){return e.join(":")}).filter(function(e){return _.isUndefined(n.get(e))&&!n.requests[e]}).value()},_loadAll:function(t,n,r){var i=this,s=e.Deferred(),o=_.first(this.getClosestUnloaded(t,n),r);_.size(o)>0?this.load(o).done(function(){i._loadAll(t,n,r).done(function(){s.resolve()})}).fail(function(){1===r?s.reject():i._loadAll(t,n,Math.ceil(r/2)).done(function(){s.resolve()})}):s.resolve();return s},load:function(e){wp.revisions.log("load",e);return this.fetch({data:{compare:e},remove:!1}).done(function(){wp.revisions.log("load:complete",e)})},sync:function(e,n,r){if("read"===e){r=r||{};r.context=this;r.data=_.extend(r.data||{},{action:"get-revision-diffs",post_id:t.settings.postId});var i=wp.ajax.send(r),s=this.requests;r.data.compare&&_.each(r.data.compare,function(e){s[e]=i});i.always(function(){r.data.compare&&_.each(r.data.compare,function(e){delete s[e]})});return i}return Backbone.Model.prototype.sync.apply(this,arguments)}});t.model.FrameState=Backbone.Model.extend({defaults:{loading:!1,error:!1,compareTwoMode:!1},initialize:function(e,n){var r={};_.bindAll(this,"receiveDiff");this._debouncedEnsureDiff=_.debounce(this._ensureDiff,200);this.revisions=n.revisions;this.diffs=new t.model.Diffs([],{revisions:this.revisions});this.diffs.set(t.settings.diffData);this.listenTo(this,"change:from",this.changeRevisionHandler);this.listenTo(this,"change:to",this.changeRevisionHandler);this.listenTo(this,"change:compareTwoMode",this.changeMode);this.listenTo(this,"update:revisions",this.updatedRevisions);this.listenTo(this.diffs,"ensure:load",this.updateLoadingStatus);this.listenTo(this,"update:diff",this.updateLoadingStatus);r.to=this.revisions.get(t.settings.to);r.from=this.revisions.get(t.settings.from);r.compareTwoMode=t.settings.compareTwoMode;r.baseUrl=t.settings.baseUrl;this.set(r);if(window.history&&window.history.pushState){this.router=new t.Router({model:this});Backbone.history.start({pushState:!0})}},updateLoadingStatus:function(){this.set("error",!1);this.set("loading",!this.diff())},changeMode:function(e,t){t&&0===this.revisions.indexOf(this.get("to"))&&this.set({from:this.revisions.at(0),to:this.revisions.at(1)})},updatedRevisions:function(e,t){this.get("compareTwoMode")||this.diffs.loadAll(this.revisions.pluck("id"),t.id,40)},diff:function(){return this.diffs.get(this._diffId)},updateDiff:function(t){var n,r,i,s;t=t||{};n=this.get("from");r=this.get("to");i=(n?n.id:0)+":"+r.id;if(this._diffId===i)return e.Deferred().reject().promise();this._diffId=i;this.trigger("update:revisions",n,r);s=this.diffs.get(i);if(s){this.receiveDiff(s);return e.Deferred().resolve().promise()}if(t.immediate)return this._ensureDiff();this._debouncedEnsureDiff();return e.Deferred().reject().promise()},changeRevisionHandler:function(){this.updateDiff()},receiveDiff:function(e){_.isUndefined(e)||_.isUndefined(e.id)?this.set({loading:!1,error:!0}):this._diffId===e.id&&this.trigger("update:diff",e)},_ensureDiff:function(){return this.diffs.ensure(this._diffId,this).always(this.receiveDiff)}});t.view.Frame=wp.Backbone.View.extend({className:"revisions",template:wp.template("revisions-frame"),initialize:function(){this.listenTo(this.model,"update:diff",this.renderDiff);this.listenTo(this.model,"change:compareTwoMode",this.updateCompareTwoMode);this.listenTo(this.model,"change:loading",this.updateLoadingStatus);this.listenTo(this.model,"change:error",this.updateErrorStatus);this.views.set(".revisions-control-frame",new t.view.Controls({model:this.model}))},render:function(){wp.Backbone.View.prototype.render.apply(this,arguments);e("html").css("overflow-y","scroll");e("#wpbody-content .wrap").append(this.el);this.updateCompareTwoMode();this.renderDiff(this.model.diff());this.views.ready();return this},renderDiff:function(e){this.views.set(".revisions-diff-frame",new t.view.Diff({model:e}))},updateLoadingStatus:function(){this.$el.toggleClass("loading",this.model.get("loading"))},updateErrorStatus:function(){this.$el.toggleClass("diff-error",this.model.get("error"))},updateCompareTwoMode:function(){this.$el.toggleClass("comparing-two-revisions",this.model.get("compareTwoMode"))}});t.view.Controls=wp.Backbone.View.extend({className:"revisions-controls",initialize:function(){_.bindAll(this,"setWidth");this.views.add(new t.view.Buttons({model:this.model}));this.views.add(new t.view.Checkbox({model:this.model}));var e=new t.model.Slider({frame:this.model,revisions:this.model.revisions}),n=new t.model.Tooltip({frame:this.model,revisions:this.model.revisions,slider:e});this.views.add(new t.view.Tooltip({model:n}));this.views.add(new t.view.Tickmarks({model:n}));this.views.add(new t.view.Slider({model:e}));this.views.add(new t.view.Metabox({model:this.model}))},ready:function(){this.top=this.$el.offset().top;this.window=e(window);this.window.on("scroll.wp.revisions",{controls:this},function(e){var t=e.data.controls,n=t.$el.parent(),r=t.window.scrollTop(),i=t.views.parent;if(r>=t.top){if(!i.$el.hasClass("pinned")){t.setWidth();n.css("height",n.height()+"px");t.window.on("resize.wp.revisions.pinning click.wp.revisions.pinning",{controls:t},function(e){e.data.controls.setWidth()})}i.$el.addClass("pinned")}else if(i.$el.hasClass("pinned")){t.window.off(".wp.revisions.pinning");t.$el.css("width","auto");i.$el.removeClass("pinned");n.css("height","auto");t.top=t.$el.offset().top}else t.top=t.$el.offset().top})},setWidth:function(){this.$el.css("width",this.$el.parent().width()+"px")}});t.view.Tickmarks=wp.Backbone.View.extend({className:"revisions-tickmarks",direction:isRtl?"right":"left",initialize:function(){this.listenTo(this.model,"change:revision",this.reportTickPosition)},reportTickPosition:function(e,t){var n,r,i,s,o=this.model.revisions.indexOf(t);r=this.$el.allOffsets();i=this.$el.parent().allOffsets();if(o===this.model.revisions.length-1)n={rightPlusWidth:r.left-i.left+1,leftPlusWidth:r.right-i.right+1};else{s=this.$("div:nth-of-type("+(o+1)+")");n=s.allPositions();_.extend(n,{left:n.left+r.left-i.left,right:n.right+r.right-i.right});_.extend(n,{leftPlusWidth:n.left+s.outerWidth(),rightPlusWidth:n.right+s.outerWidth()})}this.model.set({offset:n})},ready:function(){var e,t;e=this.model.revisions.length-1;t=1/e;this.$el.css("width",this.model.revisions.length*50+"px");_(e).times(function(e){this.$el.append('<div style="'+this.direction+": "+100*t*e+'%"></div>')},this)}});t.view.Metabox=wp.Backbone.View.extend({className:"revisions-meta",initialize:function(){this.views.add(new t.view.MetaFrom({model:this.model,className:"diff-meta diff-meta-from"}));this.views.add(new t.view.MetaTo({model:this.model}))}});t.view.Meta=wp.Backbone.View.extend({template:wp.template("revisions-meta"),events:{"click .restore-revision":"restoreRevision"},initialize:function(){this.listenTo(this.model,"update:revisions",this.render)},prepare:function(){return _.extend(this.model.toJSON()[this.type]||{},{type:this.type})},restoreRevision:function(){document.location=this.model.get("to").attributes.restoreUrl}});t.view.MetaFrom=t.view.Meta.extend({className:"diff-meta diff-meta-from",type:"from"});t.view.MetaTo=t.view.Meta.extend({className:"diff-meta diff-meta-to",type:"to"});t.view.Checkbox=wp.Backbone.View.extend({className:"revisions-checkbox",template:wp.template("revisions-checkbox"),events:{"click .compare-two-revisions":"compareTwoToggle"},initialize:function(){this.listenTo(this.model,"change:compareTwoMode",this.updateCompareTwoMode)},ready:function(){this.model.revisions.length<3&&e(".revision-toggle-compare-mode").hide()},updateCompareTwoMode:function(){this.$(".compare-two-revisions").prop("checked",this.model.get("compareTwoMode"))},compareTwoToggle:function(){this.model.set({compareTwoMode:e(".compare-two-revisions").prop("checked")})}});t.view.Tooltip=wp.Backbone.View.extend({className:"revisions-tooltip",template:wp.template("revisions-meta"),initialize:function(){this.listenTo(this.model,"change:offset",this.render);this.listenTo(this.model,"change:hovering",this.toggleVisibility);this.listenTo(this.model,"change:scrubbing",this.toggleVisibility)},prepare:function(){if(_.isNull(this.model.get("revision")))return;return _.extend({type:"tooltip"},{attributes:this.model.get("revision").toJSON()})},render:function(){var e,t,n,r,i={},s=this.model.revisions.indexOf(this.model.get("revision"))+1;r=s/this.model.revisions.length>.5;if(isRtl){t=r?"left":"right";n=r?"leftPlusWidth":t}else{t=r?"right":"left";n=r?"rightPlusWidth":t}e="right"===t?"left":"right";wp.Backbone.View.prototype.render.apply(this,arguments);i[t]=this.model.get("offset")[n]+"px";i[e]="";this.$el.toggleClass("flipped",r).css(i)},visible:function(){return this.model.get("scrubbing")||this.model.get("hovering")},toggleVisibility:function(){this.visible()?this.$el.stop().show().fadeTo(100-this.el.style.opacity*100,1):this.$el.stop().fadeTo(this.el.style.opacity*300,0,function(){e(this).hide()});return}});t.view.Buttons=wp.Backbone.View.extend({className:"revisions-buttons",template:wp.template("revisions-buttons"),events:{"click .revisions-next .button":"nextRevision","click .revisions-previous .button":"previousRevision"},initialize:function(){this.listenTo(this.model,"update:revisions",this.disabledButtonCheck)},ready:function(){this.disabledButtonCheck()},gotoModel:function(e){var t={to:this.model.revisions.at(e)};e?t.from=this.model.revisions.at(e-1):this.model.unset("from",{silent:!0});this.model.set(t)},nextRevision:function(){var e=this.model.revisions.indexOf(this.model.get("to"))+1;this.gotoModel(e)},previousRevision:function(){var e=this.model.revisions.indexOf(this.model.get("to"))-1;this.gotoModel(e)},disabledButtonCheck:function(){var t=this.model.revisions.length-1,n=0,r=e(".revisions-next .button"),i=e(".revisions-previous .button"),s=this.model.revisions.indexOf(this.model.get("to"));r.prop("disabled",t===s);i.prop("disabled",n===s)}});t.view.Slider=wp.Backbone.View.extend({className:"wp-slider",direction:isRtl?"right":"left",events:{mousemove:"mouseMove"},initialize:function(){_.bindAll(this,"start","slide","stop","mouseMove","mouseEnter","mouseLeave");this.listenTo(this.model,"update:slider",this.applySliderSettings)},ready:function(){this.$el.css("width",this.model.revisions.length*50+"px");this.$el.slider(_.extend(this.model.toJSON(),{start:this.start,slide:this.slide,stop:this.stop}));this.$el.hoverIntent({over:this.mouseEnter,out:this.mouseLeave,timeout:800});this.applySliderSettings()},mouseMove:function(t){var n=this.model.revisions.length-1,r=this.$el.allOffsets()[this.direction],i=this.$el.width(),s=i/n,o=(isRtl?e(window).width()-t.pageX:t.pageX)-r,u=Math.floor((o+s/2)/s);u<0?u=0:u>=this.model.revisions.length&&(u=this.model.revisions.length-1);this.model.set({hoveredRevision:this.model.revisions.at(u)})},mouseLeave:function(){this.model.set({hovering:!1})},mouseEnter:function(){this.model.set({hovering:!0})},applySliderSettings:function(){this.$el.slider(_.pick(this.model.toJSON(),"value","values","range"));var e=this.$("a.ui-slider-handle");if(this.model.get("compareTwoMode")){e.first().toggleClass("to-handle",!!isRtl).toggleClass("from-handle",!isRtl);e.last().toggleClass("from-handle",!!isRtl).toggleClass("to-handle",!isRtl)}else e.removeClass("from-handle to-handle")},start:function(t,n){this.model.set({scrubbing:!0});e(window).on("mousemove.wp.revisions",{view:this},function(t){var r,i=t.data.view,s=i.$el.offset().left,o=s,u=s+i.$el.width(),a=u,f="0",l="100%",c=e(n.handle);if(i.model.get("compareTwoMode")){r=c.parent().find(".ui-slider-handle");if(c.is(r.first())){a=r.last().offset().left;l=a-o}else{s=r.first().offset().left+r.first().width();f=s-o}}t.pageX<s?c.css("left",f):t.pageX>a?c.css("left",l):c.css("left",t.pageX-o)})},getPosition:function(e){return isRtl?this.model.revisions.length-e-1:e},slide:function(e,t){var n,r;if(this.model.get("compareTwoMode")){if(t.values[1]===t.values[0])return!1;isRtl&&t.values.reverse();n={from:this.model.revisions.at(this.getPosition(t.values[0])),to:this.model.revisions.at(this.getPosition(t.values[1]))}}else{n={to:this.model.revisions.at(this.getPosition(t.value))};this.getPosition(t.value)>0?n.from=this.model.revisions.at(this.getPosition(t.value)-1):n.from=undefined}r=this.model.revisions.at(this.getPosition(t.value));this.model.get("scrubbing")&&(n.hoveredRevision=r);this.model.set(n)},stop:function(){e(window).off("mousemove.wp.revisions");this.model.updateSliderSettings();this.model.set({scrubbing:!1})}});t.view.Diff=wp.Backbone.View.extend({className:"revisions-diff",template:wp.template("revisions-diff"),prepare:function(){return _.extend({fields:this.model.fields.toJSON()},this.options)}});t.Router=Backbone.Router.extend({initialize:function(e){this.model=e.model;this.routes=_.object([[this.baseUrl("?from=:from&to=:to"),"handleRoute"],[this.baseUrl("?from=:from&to=:to"),"handleRoute"]]);this.listenTo(this.model,"update:diff",_.debounce(this.updateUrl,250));this.listenTo(this.model,"change:compareTwoMode",this.updateUrl)},baseUrl:function(e){return this.model.get("baseUrl")+e},updateUrl:function(){var e=this.model.has("from")?this.model.get("from").id:0,t=this.model.get("to").id;this.model.get("compareTwoMode")?this.navigate(this.baseUrl("?from="+e+"&to="+t)):this.navigate(this.baseUrl("?revision="+t))},handleRoute:function(e,t){var n=_.isUndefined(t);if(!n){t=this.model.revisions.get(e);e=this.model.revisions.prev(t);t=t?t.id:0;e=e?e.id:0}this.model.set({from:this.model.revisions.get(parseInt(e,10)),to:this.model.revisions.get(parseInt(e,10)),compareTwoMode:n})}});t.init=function(){t.view.frame=(new t.view.Frame({model:new t.model.FrameState({},{revisions:new t.model.Revisions(t.settings.revisionData)})})).render()};e(t.init)})(jQuery);