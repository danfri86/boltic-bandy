/* global adminCommentsL10n, thousandsSeparator, list_args, QTags, ajaxurl, wpAjax */var setCommentsList,theList,theExtraList,commentReply,toggleWithKeyboard=!1;(function(e){var t,n,r,i;setCommentsList=function(){var s,o,u,a,f,l,c,h,p,d=0;s=e('input[name="_total"]',"#comments-form");o=e('input[name="_per_page"]',"#comments-form");u=e('input[name="_page"]',"#comments-form");a=function(t,n){var i,s,o,u=e("#"+n.element);i=e("#replyrow");s=e("#comment_ID",i).val();o=e("#replybtn",i);if(u.is(".unapproved")){n.data.id==s&&o.text(adminCommentsL10n.replyApprove);u.find("div.comment_status").html("0")}else{n.data.id==s&&o.text(adminCommentsL10n.reply);u.find("div.comment_status").html("1")}p=e("#"+n.element).is("."+n.dimClass)?1:-1;r(p)};f=function(t,n){var r,i,a,f,l,c,h,p=!1,d=e(t.target).attr("data-wp-lists");t.data._total=s.val()||0;t.data._per_page=o.val()||0;t.data._page=u.val()||0;t.data._url=document.location.href;t.data.comment_status=e('input[name="comment_status"]',"#comments-form").val();d.indexOf(":trash=1")!=-1?p="trash":d.indexOf(":spam=1")!=-1&&(p="spam");if(p){i=d.replace(/.*?comment-([0-9]+).*/,"$1");a=e("#comment-"+i);r=e("#"+p+"-undo-holder").html();a.find(".check-column :checkbox").prop("checked",!1);a.siblings("#replyrow").length&&commentReply.cid==i&&commentReply.close();if(a.is("tr")){f=a.children(":visible").length;h=e(".author strong",a).text();l=e('<tr id="undo-'+i+'" class="undo un'+p+'" style="display:none;"><td colspan="'+f+'">'+r+"</td></tr>")}else{h=e(".comment-author",a).text();l=e('<div id="undo-'+i+'" style="display:none;" class="undo un'+p+'">'+r+"</div>")}a.before(l);e("strong","#undo-"+i).text(h);c=e(".undo a","#undo-"+i);c.attr("href","comment.php?action=un"+p+"comment&c="+i+"&_wpnonce="+t.data._ajax_nonce);c.attr("data-wp-lists","delete:the-comment-list:comment-"+i+"::un"+p+"=1");c.attr("class","vim-z vim-destructive");e(".avatar",a).clone().prependTo("#undo-"+i+" ."+p+"-undo-inside");c.click(function(){n.wpList.del(this);e("#undo-"+i).css({backgroundColor:"#ceb"}).fadeOut(350,function(){e(this).remove();e("#comment-"+i).css("backgroundColor","").fadeIn(300,function(){e(this).show()})});return!1})}return t};l=function(e,t,n){if(t<d)return;n&&(d=t);s.val(e.toString())};i=function(r){var i,s,o,u,a=e("#dashboard_right_now");r=r||0;if(isNaN(r)||!a.length)return;i=e("span.total-count",a);s=e("span.approved-count",a);o=t(i);o+=r;u=o-t(e("span.pending-count",a))-t(e("span.spam-count",a));n(i,o);n(s,u)};t=function(e){var t=parseInt(e.html().replace(/[^0-9]+/g,""),10);return isNaN(t)?0:t};n=function(e,t){var n="";if(isNaN(t))return;t=t<1?"0":t.toString();if(t.length>3){while(t.length>3){n=thousandsSeparator+t.substr(t.length-3)+n;t=t.substr(0,t.length-3)}t+=n}e.html(t)};r=function(r){e("span.pending-count").each(function(){var i=e(this),s=t(i)+r;s<1&&(s=0);i.closest(".awaiting-mod")[0===s?"addClass":"removeClass"]("count-0");n(i,s)});i()};c=function(o,u){function w(t){return e(u.target).parent().is("span."+t)?1:e("#"+u.element).is("."+t)?-1:0}var a,f,c,p,v,m,g=e(u.target).parent().is("span.untrash"),y=e(u.target).parent().is("span.unspam"),b=e("#"+u.element).is(".unapproved");g?v=-1:v=w("trash");y?p=-1:p=w("spam");e(u.target).parent().is("span.unapprove")||(g||y)&&b?m=1:b&&(m=-1);m&&r(m);e("span.spam-count").each(function(){var r=e(this),i=t(r)+p;n(r,i)});e("span.trash-count").each(function(){var r=e(this),i=t(r)+v;n(r,i)});if(e("#dashboard_right_now").length){c=v?-1*v:0;i(c)}else{f=s.val()?parseInt(s.val(),10):0;e(u.target).parent().is("span.undo")?f++:f--;f<0&&(f=0);if("object"==typeof o&&d<u.parsed.responses[0].supplemental.time){a=u.parsed.responses[0].supplemental.total_items_i18n||"";if(a){e(".displaying-num").text(a);e(".total-pages").text(u.parsed.responses[0].supplemental.total_pages_i18n);e(".tablenav-pages").find(".next-page, .last-page").toggleClass("disabled",u.parsed.responses[0].supplemental.total_pages==e(".current-page").val())}l(f,u.parsed.responses[0].supplemental.time,!0)}else l(f,o,!1)}if(!theExtraList||theExtraList.size()===0||theExtraList.children().size()===0||g||y)return;theList.get(0).wpList.add(theExtraList.children(":eq(0)").remove().clone());h()};h=function(t){var n=e.query.get(),r=e(".total-pages").text(),i=e('input[name="_per_page"]',"#comments-form").val();n.paged||(n.paged=1);if(n.paged>r)return;if(t){theExtraList.empty();n.number=Math.min(8,i)}else{n.number=1;n.offset=Math.min(8,i)-1}n.no_placeholder=!0;n.paged++;!0===n.comment_type&&(n.comment_type="");n=e.extend(n,{action:"fetch-list",list_args:list_args,_ajax_fetch_list_nonce:e("#_ajax_fetch_list_nonce").val()});e.ajax({url:ajaxurl,global:!1,dataType:"json",data:n,success:function(e){theExtraList.get(0).wpList.add(e.rows)}})};theExtraList=e("#the-extra-comment-list").wpList({alt:"",delColor:"none",addColor:"none"});theList=e("#the-comment-list").wpList({alt:"",delBefore:f,dimAfter:a,delAfter:c,addColor:"none"}).bind("wpListDelEnd",function(t,n){var r=e(n.target).attr("data-wp-lists"),i=n.element.replace(/[^0-9]+/g,"");(r.indexOf(":trash=1")!=-1||r.indexOf(":spam=1")!=-1)&&e("#undo-"+i).fadeIn(300,function(){e(this).show()})})};commentReply={cid:"",act:"",init:function(){var t=e("#replyrow");e("a.cancel",t).click(function(){return commentReply.revert()});e("a.save",t).click(function(){return commentReply.send()});e("input#author, input#author-email, input#author-url",t).keypress(function(e){if(e.which==13){commentReply.send();e.preventDefault();return!1}});e("#the-comment-list .column-comment > p").dblclick(function(){commentReply.toggle(e(this).parent())});e("#doaction, #doaction2, #post-query-submit").click(function(){e("#the-comment-list #replyrow").length>0&&commentReply.close()});this.comments_listing=e('#comments-form > input[name="comment_status"]').val()||""},addEvents:function(t){t.each(function(){e(this).find(".column-comment > p").dblclick(function(){commentReply.toggle(e(this).parent())})})},toggle:function(t){e(t).css("display")!="none"&&e(t).find("a.vim-q").click()},revert:function(){if(e("#the-comment-list #replyrow").length<1)return!1;e("#replyrow").fadeOut("fast",function(){commentReply.close()});return!1},close:function(){var t,n=e("#replyrow");if(n.parent().is("#com-reply"))return;if(this.cid&&this.act=="edit-comment"){t=e("#comment-"+this.cid);t.fadeIn(300,function(){t.show()}).css("backgroundColor","")}typeof QTags!="undefined"&&QTags.closeAllTags("replycontent");e("#add-new-comment").css("display","");n.hide();e("#com-reply").append(n);e("#replycontent").css("height","").val("");e("#edithead input").val("");e(".error",n).html("").hide();e(".spinner",n).hide();this.cid=""},open:function(t,n,r){var i,s,o,u,a,f=this,l=e("#comment-"+t),c=l.height();f.close();f.cid=t;i=e("#replyrow");s=e("#inline-"+t);r=r||"replyto";o="edit"==r?"edit":"replyto";o=f.act=o+"-comment";e("#action",i).val(o);e("#comment_post_ID",i).val(n);e("#comment_ID",i).val(t);if(r=="edit"){e("#author",i).val(e("div.author",s).text());e("#author-email",i).val(e("div.author-email",s).text());e("#author-url",i).val(e("div.author-url",s).text());e("#status",i).val(e("div.comment_status",s).text());e("#replycontent",i).val(e("textarea.comment",s).val());e("#edithead, #savebtn",i).show();e("#replyhead, #replybtn, #addhead, #addbtn",i).hide();if(c>120){a=c>500?500:c;e("#replycontent",i).css("height",a+"px")}l.after(i).fadeOut("fast",function(){e("#replyrow").fadeIn(300,function(){e(this).show()})})}else if(r=="add"){e("#addhead, #addbtn",i).show();e("#replyhead, #replybtn, #edithead, #editbtn",i).hide();e("#the-comment-list").prepend(i);e("#replyrow").fadeIn(300)}else{u=e("#replybtn",i);e("#edithead, #savebtn, #addhead, #addbtn",i).hide();e("#replyhead, #replybtn",i).show();l.after(i);l.hasClass("unapproved")?u.text(adminCommentsL10n.replyApprove):u.text(adminCommentsL10n.reply);e("#replyrow").fadeIn(300,function(){e(this).show()})}setTimeout(function(){var t,n,r,i,s;t=e("#replyrow").offset().top;n=t+e("#replyrow").height();r=window.pageYOffset||document.documentElement.scrollTop;i=document.documentElement.clientHeight||window.innerHeight||0;s=r+i;s-20<n?window.scroll(0,n-i+35):t-20<r&&window.scroll(0,t-35);e("#replycontent").focus().keyup(function(e){e.which==27&&commentReply.revert()})},600);return!1},send:function(){var t={};e("#replysubmit .error").hide();e("#replysubmit .spinner").show();e("#replyrow input").not(":button").each(function(){var n=e(this);t[n.attr("name")]=n.val()});t.content=e("#replycontent").val();t.id=t.comment_post_ID;t.comments_listing=this.comments_listing;t.p=e('[name="p"]').val();e("#comment-"+e("#comment_ID").val()).hasClass("unapproved")&&(t.approve_parent=1);e.ajax({type:"POST",url:ajaxurl,data:t,success:function(e){commentReply.show(e)},error:function(e){commentReply.error(e)}});return!1},show:function(t){var n=this,i,s,o,u,a;if(typeof t=="string"){n.error({responseText:t});return!1}i=wpAjax.parseAjaxResponse(t);if(i.errors){n.error({responseText:wpAjax.broken});return!1}n.revert();i=i.responses[0];o="#comment-"+i.id;"edit-comment"==n.act&&e(o).remove();if(i.supplemental.parent_approved){a=e("#comment-"+i.supplemental.parent_approved);r(-1);if(this.comments_listing=="moderated"){a.animate({backgroundColor:"#CCEEBB"},400,function(){a.fadeOut()});return}}s=e.trim(i.data);e(s).hide();e("#replyrow").after(s);o=e(o);n.addEvents(o);u=o.hasClass("unapproved")?"#FFFFE0":o.closest(".widefat, .postbox").css("backgroundColor");o.animate({backgroundColor:"#CCEEBB"},300).animate({backgroundColor:u},300,function(){a&&a.length&&a.animate({backgroundColor:"#CCEEBB"},300).animate({backgroundColor:u},300).removeClass("unapproved").addClass("approved").find("div.comment_status").html("1")})},error:function(t){var n=t.statusText;e("#replysubmit .spinner").hide();t.responseText&&(n=t.responseText.replace(/<.[^<>]*?>/g,""));n&&e("#replysubmit .error").html(n).show()},addcomment:function(t){var n=this;e("#add-new-comment").fadeOut(200,function(){n.open(0,t,"add");e("table.comments-box").css("display","");e("#no-comments").remove()})}};e(document).ready(function(){var t,n,r,i;setCommentsList();commentReply.init();e(document).delegate("span.delete a.delete","click",function(){return!1});if(typeof e.table_hotkeys!="undefined"){t=function(t){return function(){var n,r;n="next"==t?"first":"last";r=e(".tablenav-pages ."+t+"-page:not(.disabled)");r.length&&(window.location=r[0].href.replace(/\&hotkeys_highlight_(first|last)=1/g,"")+"&hotkeys_highlight_"+n+"=1")}};n=function(t,n){window.location=e("span.edit a",n).attr("href")};r=function(){toggleWithKeyboard=!0;e("input:checkbox","#cb").click().prop("checked",!1);toggleWithKeyboard=!1};i=function(t){return function(){var n=e('select[name="action"]');e('option[value="'+t+'"]',n).prop("selected",!0);e("#doaction").click()}};e.table_hotkeys(e("table.widefat"),["a","u","s","d","r","q","z",["e",n],["shift+x",r],["shift+a",i("approve")],["shift+s",i("spam")],["shift+d",i("delete")],["shift+t",i("trash")],["shift+z",i("untrash")],["shift+u",i("unapprove")]],{highlight_first:adminCommentsL10n.hotkeys_highlight_first,highlight_last:adminCommentsL10n.hotkeys_highlight_last,prev_page_link_cb:t("prev"),next_page_link_cb:t("next")})}})})(jQuery);