/* global _wpThemeSettings, confirm */window.wp=window.wp||{};(function(e){var t,n;t=wp.themes=wp.themes||{};t.data=_wpThemeSettings;n=t.data.l10n;_.extend(t,{model:{},view:{},routes:{},router:{},template:wp.template});t.model=Backbone.Model.extend({});t.view.Appearance=wp.Backbone.View.extend({el:"#wpbody-content .wrap .theme-browser",window:e(window),page:0,initialize:function(){_.bindAll(this,"scroller");this.window.bind("scroll",_.throttle(this.scroller,300))},render:function(){this.view=new t.view.Themes({collection:this.collection,parent:this});this.search();this.view.render();this.$el.empty().append(this.view.el).addClass("rendered");this.$el.append('<br class="clear"/>')},search:function(){var r,i=this;if(t.data.themes.length===1)return;r=new t.view.Search({collection:i.collection});r.render();e("#wpbody h2:first").append(e.parseHTML('<label class="screen-reader-text" for="theme-search-input">'+n.search+"</label>")).append(r.el)},scroller:function(){var e=this,t,n;t=this.window.scrollTop()+e.window.height();n=e.$el.offset().top+e.$el.outerHeight(!1)-e.window.height();n=Math.round(n*.9);t>n&&this.trigger("theme:scroll")}});t.Collection=Backbone.Collection.extend({model:t.model,terms:"",doSearch:function(e){if(this.terms===e)return;this.terms=e;this.terms.length>0&&this.search(this.terms);this.terms===""&&this.reset(t.data.themes);this.trigger("update")},search:function(e){var n,r,i;this.reset(t.data.themes,{silent:!0});e=e.replace(" ",")(?=.*");n=new RegExp("^(?=.*"+e+").+","i");r=this.filter(function(t){i=_.union(t.get("name"),t.get("description"),t.get("author"),t.get("tags"));n.test(t.get("author"))&&e.length>2&&t.set("displayAuthor",!0);return n.test(i)});this.reset(r)},paginate:function(e){var t=this;e=e||0;t=_(t.rest(15*e));t=_(t.first(15));return t}});t.view.Theme=wp.Backbone.View.extend({className:"theme",state:"grid",html:t.template("theme"),events:{click:"expand",touchend:"expand",touchmove:"preventExpand"},touchDrag:!1,render:function(){var e=this.model.toJSON();this.$el.html(this.html(e));this.activeTheme();this.model.get("displayAuthor")&&this.$el.addClass("display-author")},activeTheme:function(){this.model.get("active")&&this.$el.addClass("active")},expand:function(t){var n=this;if(this.touchDrag===!0)return this.touchDrag=!1;t=t||window.event;if(e(t.target).is(".theme-actions a"))return;this.trigger("theme:expand",n.model.cid)},preventExpand:function(){this.touchDrag=!0}});t.view.Details=wp.Backbone.View.extend({className:"theme-overlay",events:{click:"collapse","click .delete-theme":"deleteTheme","click .left":"previousTheme","click .right":"nextTheme"},html:t.template("theme-single"),render:function(){var e=this.model.toJSON();this.$el.html(this.html(e));this.activeTheme();this.navigation();this.screenshotCheck(this.$el)},activeTheme:function(){this.$el.toggleClass("active",this.model.get("active"))},collapse:function(n){var r=this,i;n=n||window.event;if(t.data.themes.length===1)return;if(e(n.target).is(".theme-backdrop")||e(n.target).is("div.close")||n.keyCode===27){e("body").addClass("closing-overlay");this.$el.fadeOut(130,function(){e("body").removeClass("theme-overlay-open closing-overlay");r.closeOverlay();i=document.body.scrollTop;t.router.navigate(t.router.baseUrl(""),{replace:!0});document.body.scrollTop=i})}},navigation:function(){this.model.cid===this.model.collection.at(0).cid&&this.$el.find(".left").addClass("disabled");this.model.cid===this.model.collection.at(this.model.collection.length-1).cid&&this.$el.find(".right").addClass("disabled")},closeOverlay:function(){this.remove();this.unbind();this.trigger("theme:collapse")},deleteTheme:function(){return confirm(t.data.settings.confirmDelete)},nextTheme:function(){var e=this;e.trigger("theme:next",e.model.cid)},previousTheme:function(){var e=this;e.trigger("theme:previous",e.model.cid)},screenshotCheck:function(e){var t,n;t=e.find(".screenshot img");n=new Image;n.src=t.attr("src");n.width&&n.width<=300&&e.addClass("small-screenshot")}});t.view.Themes=wp.Backbone.View.extend({className:"themes",$overlay:e("div.theme-overlay"),index:0,count:e(".theme-count"),initialize:function(t){var n=this;this.parent=t.parent;this.setView("grid");n.currentTheme();this.listenTo(n.collection,"update",function(){n.parent.page=0;n.currentTheme();n.render(this)});this.listenTo(this.parent,"theme:scroll",function(){n.renderThemes(n.parent.page)});e("body").on("keyup",function(e){if(!n.overlay)return;e.keyCode===39&&n.overlay.nextTheme();e.keyCode===37&&n.overlay.previousTheme();e.keyCode===27&&n.overlay.collapse(e)})},render:function(){this.$el.html("");if(t.data.themes.length===1){this.singleTheme=new t.view.Details({model:this.collection.models[0]});this.singleTheme.render();this.$el.addClass("single-theme");this.$el.append(this.singleTheme.el)}this.renderThemes(this.parent.page);this.count.text(this.collection.length)},renderThemes:function(r){var i=this;i.instance=i.collection.paginate(r);if(i.instance.length===0)return;r>=1&&e(".add-new-theme").remove();i.instance.each(function(e){i.theme=new t.view.Theme({model:e});i.theme.render();i.$el.append(i.theme.el);i.listenTo(i.theme,"theme:expand",i.expand,i)});t.data.settings.canInstall&&this.$el.append('<div class="theme add-new-theme"><a href="'+t.data.settings.installURI+'"><div class="theme-screenshot"><span></span></div><h3 class="theme-name">'+n.addNew+"</h3></a></div>");this.parent.page++},currentTheme:function(){var e=this,t;t=e.collection.findWhere({active:!0});if(t){e.collection.remove(t);e.collection.add(t,{at:0})}},setView:function(e){return e},expand:function(n){var r=this;this.model=r.collection.get(n);t.router.navigate(t.router.baseUrl("?theme="+this.model.id),{replace:!0});this.setView("detail");e("body").addClass("theme-overlay-open");this.overlay=new t.view.Details({model:r.model});this.overlay.render();this.$overlay.html(this.overlay.el);this.listenTo(this.overlay,"theme:next",function(){r.next([r.model.cid])}).listenTo(this.overlay,"theme:previous",function(){r.previous([r.model.cid])})},next:function(e){var t=this,n,r;n=t.collection.get(e[0]);r=t.collection.at(t.collection.indexOf(n)+1);if(r!==undefined){this.overlay.closeOverlay();t.theme.trigger("theme:expand",r.cid)}},previous:function(e){var t=this,n,r;n=t.collection.get(e[0]);r=t.collection.at(t.collection.indexOf(n)-1);if(r!==undefined){this.overlay.closeOverlay();t.theme.trigger("theme:expand",r.cid)}}});t.view.Search=wp.Backbone.View.extend({tagName:"input",className:"theme-search",attributes:{placeholder:n.searchPlaceholder,type:"search"},events:{input:"search",keyup:"search",change:"search",search:"search"},search:function(e){e.type==="keyup"&&e.which===27&&(e.target.value="");this.collection.doSearch(e.target.value);e.target.value?t.router.navigate(t.router.baseUrl("?search="+e.target.value),{replace:!0}):t.router.navigate(t.router.baseUrl(""),{replace:!0})}});t.routes=Backbone.Router.extend({initialize:function(){this.routes=_.object([])},baseUrl:function(e){return t.data.settings.root+e}});t.Run={init:function(){this.themes=new t.Collection(t.data.themes);this.view=new t.view.Appearance({collection:this.themes});this.render()},render:function(){this.view.render();this.routes();"undefined"!=typeof t.data.settings.theme&&""!==t.data.settings.theme&&this.view.view.theme.trigger("theme:expand",this.view.collection.findWhere({id:t.data.settings.theme}));if("undefined"!=typeof t.data.settings.search&&""!==t.data.settings.search){e(".theme-search").val(t.data.settings.search);this.themes.doSearch(t.data.settings.search)}window.history&&window.history.pushState&&Backbone.history.start({pushState:!0,silent:!0})},routes:function(){t.router=new t.routes}};jQuery(document).ready(_.bind(t.Run.init,t.Run))})(jQuery);var tb_position;jQuery(document).ready(function(e){tb_position=function(){var t=e("#TB_window"),n=e(window).width(),r=e(window).height(),i=1040<n?1040:n,s=0;e("body.admin-bar").length&&(s=parseInt(jQuery("#wpadminbar").css("height"),10));if(t.size()){t.width(i-50).height(r-45-s);e("#TB_iframeContent").width(i-50).height(r-75-s);t.css({"margin-left":"-"+parseInt((i-50)/2,10)+"px"});typeof document.body.style.maxWidth!="undefined"&&t.css({top:20+s+"px","margin-top":"0"})}};e(window).resize(function(){tb_position()})});