/* global imageEditL10n, ajaxurl, confirm */(function(e){var t=window.imageEdit={iasapi:{},hold:{},postid:"",intval:function(e){return e|0},setDisabled:function(t,n){if(n){t.removeClass("disabled");e("input",t).removeAttr("disabled")}else{t.addClass("disabled");e("input",t).prop("disabled",!0)}},init:function(t){var n=this,r=e("#image-editor-"+n.postid),i=n.intval(e("#imgedit-x-"+t).val()),s=n.intval(e("#imgedit-y-"+t).val());n.postid!==t&&r.length&&n.close(n.postid);n.hold.w=n.hold.ow=i;n.hold.h=n.hold.oh=s;n.hold.xy_ratio=i/s;n.hold.sizer=parseFloat(e("#imgedit-sizer-"+t).val());n.postid=t;e("#imgedit-response-"+t).empty();e('input[type="text"]',"#imgedit-panel-"+t).keypress(function(t){var n=t.keyCode;36<n&&n<41&&e(this).blur();if(13===n){t.preventDefault();t.stopPropagation();return!1}})},toggleEditor:function(t,n){var r=e("#imgedit-wait-"+t);n?r.height(e("#imgedit-panel-"+t).height()).fadeIn("fast"):r.fadeOut("fast")},toggleHelp:function(t){e(t).siblings(".imgedit-help").slideToggle("fast");return!1},getTarget:function(t){return e('input[name="imgedit-target-'+t+'"]:checked',"#imgedit-save-target-"+t).val()||"full"},scaleChanged:function(t,n){var r=e("#imgedit-scale-width-"+t),i=e("#imgedit-scale-height-"+t),s=e("#imgedit-scale-warn-"+t),o="",u="";if(n){u=r.val()!==""?Math.round(r.val()/this.hold.xy_ratio):"";i.val(u)}else{o=i.val()!==""?Math.round(i.val()*this.hold.xy_ratio):"";r.val(o)}u&&u>this.hold.oh||o&&o>this.hold.ow?s.css("visibility","visible"):s.css("visibility","hidden")},getSelRatio:function(t){var n=this.hold.w,r=this.hold.h,i=this.intval(e("#imgedit-crop-width-"+t).val()),s=this.intval(e("#imgedit-crop-height-"+t).val());return i&&s?i+":"+s:n&&r?n+":"+r:"1:1"},filterHistory:function(t,n){var r=e("#imgedit-history-"+t).val(),i,s,o,u,a=[];if(r!==""){r=JSON.parse(r);i=this.intval(e("#imgedit-undone-"+t).val());if(i>0)while(i>0){r.pop();i--}if(n){if(!r.length){this.hold.w=this.hold.ow;this.hold.h=this.hold.oh;return""}o=r[r.length-1];o=o.c||o.r||o.f||!1;if(o){this.hold.w=o.fw;this.hold.h=o.fh}}for(s in r){u=r[s];u.hasOwnProperty("c")?a[s]={c:{x:u.c.x,y:u.c.y,w:u.c.w,h:u.c.h}}:u.hasOwnProperty("r")?a[s]={r:u.r.r}:u.hasOwnProperty("f")&&(a[s]={f:u.f.f})}return JSON.stringify(a)}return""},refreshEditor:function(n,r,i){var s=this,o,u;s.toggleEditor(n,1);o={action:"imgedit-preview",_ajax_nonce:r,postid:n,history:s.filterHistory(n,1),rand:s.intval(Math.random()*1e6)};u=e('<img id="image-preview-'+n+'" />').on("load",function(){var r,s,o=e("#imgedit-crop-"+n),a=t;o.empty().append(u);r=Math.max(a.hold.w,a.hold.h);s=Math.max(e(u).width(),e(u).height());a.hold.sizer=r>s?s/r:1;a.initCrop(n,u,o);a.setCropSelection(n,0);typeof i!="undefined"&&i!==null&&i();e("#imgedit-history-"+n).val()&&e("#imgedit-undone-"+n).val()==="0"?e("input.imgedit-submit-btn","#imgedit-panel-"+n).removeAttr("disabled"):e("input.imgedit-submit-btn","#imgedit-panel-"+n).prop("disabled",!0);a.toggleEditor(n,0)}).on("error",function(){e("#imgedit-crop-"+n).empty().append('<div class="error"><p>'+imageEditL10n.error+"</p></div>");s.toggleEditor(n,0)}).attr("src",ajaxurl+"?"+e.param(o))},action:function(t,n,r){var i=this,s,o,u,a,f;if(i.notsaved(t))return!1;s={action:"image-editor",_ajax_nonce:n,postid:t};if("scale"===r){o=e("#imgedit-scale-width-"+t),u=e("#imgedit-scale-height-"+t),a=i.intval(o.val()),f=i.intval(u.val());if(a<1){o.focus();return!1}if(f<1){u.focus();return!1}if(a===i.hold.ow||f===i.hold.oh)return!1;s["do"]="scale";s.fwidth=a;s.fheight=f}else{if("restore"!==r)return!1;s["do"]="restore"}i.toggleEditor(t,1);e.post(ajaxurl,s,function(n){e("#image-editor-"+t).empty().append(n);i.toggleEditor(t,0)})},save:function(n,r){var i,s=this.getTarget(n),o=this.filterHistory(n,0);if(""===o)return!1;this.toggleEditor(n,1);i={action:"image-editor",_ajax_nonce:r,postid:n,history:o,target:s,context:e("#image-edit-context").length?e("#image-edit-context").val():null,"do":"save"};e.post(ajaxurl,i,function(r){var i=JSON.parse(r);if(i.error){e("#imgedit-response-"+n).html('<div class="error"><p>'+i.error+"</p><div>");t.close(n);return}i.fw&&i.fh&&e("#media-dims-"+n).html(i.fw+" &times; "+i.fh);i.thumbnail&&e(".thumbnail","#thumbnail-head-"+n).attr("src",""+i.thumbnail);i.msg&&e("#imgedit-response-"+n).html('<div class="updated"><p>'+i.msg+"</p></div>");t.close(n)})},open:function(t,n){var r,i=e("#image-editor-"+t),s=e("#media-head-"+t),o=e("#imgedit-open-btn-"+t),u=o.siblings(".spinner");o.prop("disabled",!0);u.show();r={action:"image-editor",_ajax_nonce:n,postid:t,"do":"open"};i.load(ajaxurl,r,function(){i.fadeIn("fast");s.fadeOut("fast",function(){o.removeAttr("disabled");u.hide()})})},imgLoaded:function(t){var n=e("#image-preview-"+t),r=e("#imgedit-crop-"+t);this.initCrop(t,n,r);this.setCropSelection(t,0);this.toggleEditor(t,0)},initCrop:function(n,r,i){var s=this,o=e("#imgedit-sel-width-"+n),u=e("#imgedit-sel-height-"+n);s.iasapi=e(r).imgAreaSelect({parent:i,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,onInit:function(){i.children().mousedown(function(e){var t=!1,r,i;if(e.shiftKey){r=s.iasapi.getSelection();i=s.getSelRatio(n);t=r&&r.width&&r.height?r.width+":"+r.height:i}s.iasapi.setOptions({aspectRatio:t})})},onSelectStart:function(){t.setDisabled(e("#imgedit-crop-sel-"+n),1)},onSelectEnd:function(e,r){t.setCropSelection(n,r)},onSelectChange:function(e,n){var r=t.hold.sizer;o.val(t.round(n.width/r));u.val(t.round(n.height/r))}})},setCropSelection:function(t,n){var r,i=e("#imgedit-minthumb-"+t).val()||"128:128",s=this.hold.sizer;i=i.split(":");n=n||0;if(!n||n.width<3&&n.height<3){this.setDisabled(e(".imgedit-crop","#imgedit-panel-"+t),0);this.setDisabled(e("#imgedit-crop-sel-"+t),0);e("#imgedit-sel-width-"+t).val("");e("#imgedit-sel-height-"+t).val("");e("#imgedit-selection-"+t).val("");return!1}if(n.width<i[0]*s&&n.height<i[1]*s){this.setDisabled(e(".imgedit-crop","#imgedit-panel-"+t),0);e("#imgedit-selection-"+t).val("");return!1}r={x:n.x1,y:n.y1,w:n.width,h:n.height};this.setDisabled(e(".imgedit-crop","#imgedit-panel-"+t),1);e("#imgedit-selection-"+t).val(JSON.stringify(r))},close:function(t,n){n=n||!1;if(n&&this.notsaved(t))return!1;this.iasapi={};this.hold={};e("#image-editor-"+t).fadeOut("fast",function(){e("#media-head-"+t).fadeIn("fast");e(this).empty()})},notsaved:function(t){var n=e("#imgedit-history-"+t).val(),r=n!==""?JSON.parse(n):[],i=this.intval(e("#imgedit-undone-"+t).val());return i<r.length?confirm(e("#imgedit-leaving-"+t).html())?!1:!0:!1},addStep:function(t,n,r){var i=this,s=e("#imgedit-history-"+n),o=s.val()!==""?JSON.parse(s.val()):[],u=e("#imgedit-undone-"+n),a=i.intval(u.val());while(a>0){o.pop();a--}u.val(0);o.push(t);s.val(JSON.stringify(o));i.refreshEditor(n,r,function(){i.setDisabled(e("#image-undo-"+n),!0);i.setDisabled(e("#image-redo-"+n),!1)})},rotate:function(t,n,r,i){if(e(i).hasClass("disabled"))return!1;this.addStep({r:{r:t,fw:this.hold.h,fh:this.hold.w}},n,r)},flip:function(t,n,r,i){if(e(i).hasClass("disabled"))return!1;this.addStep({f:{f:t,fw:this.hold.w,fh:this.hold.h}},n,r)},crop:function(t,n,r){var i=e("#imgedit-selection-"+t).val(),s=this.intval(e("#imgedit-sel-width-"+t).val()),o=this.intval(e("#imgedit-sel-height-"+t).val());if(e(r).hasClass("disabled")||i==="")return!1;i=JSON.parse(i);if(i.w>0&&i.h>0&&s>0&&o>0){i.fw=s;i.fh=o;this.addStep({c:i},t,n)}},undo:function(t,n){var r=this,i=e("#image-undo-"+t),s=e("#imgedit-undone-"+t),o=r.intval(s.val())+1;if(i.hasClass("disabled"))return;s.val(o);r.refreshEditor(t,n,function(){var n=e("#imgedit-history-"+t),s=n.val()!==""?JSON.parse(n.val()):[];r.setDisabled(e("#image-redo-"+t),!0);r.setDisabled(i,o<s.length)})},redo:function(t,n){var r=this,i=e("#image-redo-"+t),s=e("#imgedit-undone-"+t),o=r.intval(s.val())-1;if(i.hasClass("disabled"))return;s.val(o);r.refreshEditor(t,n,function(){r.setDisabled(e("#image-undo-"+t),!0);r.setDisabled(i,o>0)})},setNumSelection:function(t){var n,r=e("#imgedit-sel-width-"+t),i=e("#imgedit-sel-height-"+t),s=this.intval(r.val()),o=this.intval(i.val()),u=e("#image-preview-"+t),a=u.height(),f=u.width(),l=this.hold.sizer,c,h,p,d,v=this.iasapi;if(s<1){r.val("");return!1}if(o<1){i.val("");return!1}if(s&&o&&(n=v.getSelection())){p=n.x1+Math.round(s*l);d=n.y1+Math.round(o*l);c=n.x1;h=n.y1;if(p>f){c=0;p=f;r.val(Math.round(p/l))}if(d>a){h=0;d=a;i.val(Math.round(d/l))}v.setSelection(c,h,p,d);v.update();this.setCropSelection(t,v.getSelection())}},round:function(e){var t;e=Math.round(e);if(this.hold.sizer>.6)return e;t=e.toString().slice(-1);return"1"===t?e-1:"9"===t?e+1:e},setRatioSelection:function(t,n,r){var i,s,o=this.intval(e("#imgedit-crop-width-"+t).val()),u=this.intval(e("#imgedit-crop-height-"+t).val()),a=e("#image-preview-"+t).height();if(!this.intval(e(r).val())){e(r).val("");return}if(o&&u){this.iasapi.setOptions({aspectRatio:o+":"+u});if(i=this.iasapi.getSelection(!0)){s=Math.ceil(i.y1+(i.x2-i.x1)/(o/u));if(s>a){s=a;n?e("#imgedit-crop-height-"+t).val(""):e("#imgedit-crop-width-"+t).val("")}this.iasapi.setSelection(i.x1,i.y1,i.x2,s);this.iasapi.update()}}}}})(jQuery);